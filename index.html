<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<title>Cinematix Planner</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --bg:#0b0f15; --panel:#0f141c; --card:#131a23; --line:#243244;
  --text:#ecf2f8; --muted:#a3b5c7;
  --accent:#49d3c6; --accent2:#7ca7ff; --accent3:#ed7a5f;
  --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
}
*{box-sizing:border-box} html,body{min-height:100%}
html{background:#0b0f15}
body{margin:0;padding:env(safe-area-inset-top) 0 env(safe-area-inset-bottom);background:radial-gradient(1200px 600px at 50% -200px, #0f1724 0%, #0b0f15 55%), linear-gradient(180deg,#0b0f15 0,#0b0f15 100%);
  color:var(--text); font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Helvetica,Arial,sans-serif; -webkit-font-smoothing:antialiased; overflow-x:hidden}
.container{max-width:480px;margin:0 auto;padding:14px 14px 18px}
/* Top bar */
header.top{position:sticky;top:env(safe-area-inset-top);z-index:20;background:rgba(11,15,21,.72);backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(255,255,255,.06); padding:10px 12px; display:flex; align-items:center; gap:10px}
.logo{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.3px}
.logo .glyph{width:24px;height:24px;border-radius:8px;background:conic-gradient(from 0deg, var(--accent), var(--accent2), var(--accent3), var(--accent));
  box-shadow:0 0 0 2px rgba(255,255,255,.1) inset}
.btn{border:1px solid var(--line); background:linear-gradient(180deg,#131b25,#0f141c); color:var(--text); border-radius:12px; padding:10px 12px; font-weight:700}
.btn.primary{background:linear-gradient(180deg, var(--accent), #2dad9e); color:#042e2a; border:none}
.btn.ghost{background:transparent}
/* Tabs */
.tabs{display:flex;gap:8px;margin:10px 0;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tabs::-webkit-scrollbar{display:none}
.tab{flex:0 0 auto;padding:10px;text-align:center;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,#131b25,#0f141c);color:var(--muted);font-weight:800}
.tab.active{background:linear-gradient(180deg,var(--accent),#2dad9e);color:#042e2a;border-color:transparent}
/* Cards & layout */
.card{background:linear-gradient(180deg,#151e29,#121923); border:1px solid var(--line); border-radius:18px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
.section-title{font-weight:900;letter-spacing:.2px;margin:0 0 8px 0}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.space{flex:1}
input,select,textarea{width:100%;background:#0d141c;color:var(--text);border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:16px;outline:none}
textarea{min-height:90px;resize:vertical}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#0d141c}
.badge.ok{border-color:#164a2b;background:#0b1e14;color:#9ee7b5}.badge.warn{border-color:#584114;background:#1f1605;color:#ffd89b}.badge.danger{border-color:#5a1a1a;background:#220a0a;color:#fecaca}
/* Calendar */
.calendar .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.weekdays,.cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.weekdays div{font-size:12px;color:var(--muted);text-align:center}
.day{border:1px solid var(--line);border-radius:12px;min-height:70px;background:linear-gradient(180deg,#131b22,#0f141c);padding:8px;display:flex;flex-direction:column}
.day .num{font-weight:900;opacity:.95;margin-bottom:8px}
.day.other{opacity:.45}
.day.today{outline:2px solid var(--accent2)}
.chips{display:flex;gap:4px;flex-wrap:wrap}
.chip{font-size:10px;font-weight:900;padding:2px 7px;border-radius:999px;color:#041e1b}
.chip.shoot{background:var(--accent3)} .chip.deadline{background:var(--warn)} .chip.review{background:var(--accent2)} .chip.delivery{background:var(--danger)} .chip.shot{background:var(--accent)} .chip.task{background:var(--accent2)} .chip.note{background:var(--accent3)}
/* Lists */
.item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:start}
.item+.item{margin-top:10px}
.item h3{margin:0}
.kicker{font-size:12px;color:var(--muted)}
/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;z-index:50}
    .sheet{width:100%;max-width:520px;margin:0 auto;background:linear-gradient(180deg,#151e29,#111822);border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);padding:14px;box-shadow:0 -10px 30px rgba(0,0,0,.35);max-height:90vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
.sheet .title{font-weight:900;margin:0 0 8px 0}
.sheet .grid{display:grid;gap:10px}
.footer{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
@media (orientation:landscape){body::before{content:'Rotate to portrait for best experience';position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.6);z-index:9999;color:#fff}}
</style>
</head>
<body>
<div class="container">
  <header class="top">
    <div class="logo"><div class="glyph"></div><div>Cinematix</div></div>
    <div class="space"></div>
    <button class="btn" id="btnExport">Export</button>
    <button class="btn" id="btnImport">Import</button>
    <input type="file" id="fileImport" accept="application/json" style="display:none">
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="calendar">Calendar</div>
    <div class="tab" data-tab="projects">Projects</div>
    <div class="tab" data-tab="shots">Shots</div>
    <div class="tab" data-tab="tasks">Tasks</div>
    <div class="tab" data-tab="notes">Notes</div>
  </div>

  <!-- CALENDAR -->
  <section id="tab-calendar">
    <div class="card calendar">
      <div class="head">
        <button class="btn" id="prevMonth">‹</button>
        <div class="section-title" id="calTitle"></div>
        <button class="btn" id="nextMonth">›</button>
      </div>
      <div class="weekdays" id="weekdays"></div>
      <div class="cal" id="calGrid"></div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="row">
        <div class="section-title">Agenda</div>
        <div class="space"></div>
        <button class="btn primary" id="quickAddEvent">+ Event</button>
      </div>
      <div id="agenda"></div>
    </div>
  </section>

  <!-- PROJECTS -->
  <section id="tab-projects" style="display:none">
    <div class="card">
      <div class="row">
        <input id="projSearch" placeholder="Search projects or clients">
        <button class="btn primary" id="btnNewProject">+ Project</button>
      </div>
    </div>
    <div id="projectsList" style="margin-top:10px"></div>
  </section>

  <!-- SHOTS -->
  <section id="tab-shots" style="display:none">
    <div class="card">
      <div class="row">
        <select id="shotStatusFilter">
          <option value="all">All</option>
          <option value="Bid">Bid</option>
          <option value="WIP">WIP</option>
          <option value="Review">Review</option>
          <option value="Final">Final</option>
        </select>
        <div class="space"></div>
        <button class="btn" id="btnNewStoryboard">+ Storyboard</button>
        <button class="btn primary" id="btnNewShot">+ Shot</button>
      </div>
    </div>
    <div id="storyboardsList" style="margin-top:10px"></div>
    <div id="shotsList" style="margin-top:10px"></div>
  </section>

  <!-- TASKS -->
  <section id="tab-tasks" style="display:none">
    <div class="card">
      <div class="row">
        <select id="taskFilter">
          <option value="all">All</option>
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Blocked">Blocked</option>
          <option value="Done">Done</option>
        </select>
        <div class="space"></div>
        <button class="btn primary" id="btnNewTask">+ Task</button>
      </div>
    </div>
    <div id="tasksList" style="margin-top:10px"></div>
  </section>
  <!-- NOTES -->
  <section id="tab-notes" style="display:none">
    <div class="card">
      <div class="row">
        <select id="noteFilter"><option value="all">All</option></select>
        <div class="space"></div>
        <button class="btn primary" id="btnNewNote">+ Note</button>
      </div>
    </div>
    <div id="notesList" style="margin-top:10px"></div>
  </section>

  <div class="footer">Offline‑ready • Add to Home Screen from Safari</div>
</div>

<!-- Modal sheet -->
<div class="modal" id="modal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="title" id="modalTitle">New</div>
      <button class="btn ghost" id="modalClose" type="button">Close</button>
    </div>
    <div class="grid" id="modalBody"></div>
    <div class="row" style="margin:10px 0 20px">
      <div class="space"></div>
      <button class="btn" id="modalDelete" style="display:none" type="button">Delete</button>
      <button class="btn primary" id="modalSave" type="button">Save</button>
    </div>
  </div>
</div>

<script>
// ---------- Storage ----------
const KEY='cinematix.v3';
function load(){ try{return JSON.parse(localStorage.getItem(KEY)||'{}')}catch{return{}} }
function save(s){
  try{ localStorage.setItem(KEY, JSON.stringify(s)); }
  catch(err){ console.error('Save failed', err); throw err; }
}
function init(){
  const s = load();
  s.projects = s.projects||[];
  s.events = s.events||[];
  s.tasks = s.tasks||[];
  s.shots = s.shots||[]; // Shots
  s.storyboards = s.storyboards||[];
  s.notes = s.notes||[];
  return s;
}
let store = init();

// ---------- Helpers ----------
const $ = sel=>document.querySelector(sel);
const $$ = sel=>Array.from(document.querySelectorAll(sel));
function uid(){ return (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)); }
function fmt(d){ return d?new Date(d).toLocaleDateString():''; }
function formRow(html){ const d=document.createElement('div'); d.innerHTML=html; return d.firstElementChild; }
function getLabel(type,id){
  if(type==='project') return store.projects.find(p=>p.id===id)?.title||'Project';
  if(type==='shot'){ const s=store.shots.find(x=>x.id===id); return s?`${s.sequence||'SEQ'} / ${s.scene||'SC'} / ${s.shot||'SHOT'}`:'Shot'; }
  if(type==='task') return store.tasks.find(t=>t.id===id)?.title||'Task';
  if(type==='event') return store.events.find(e=>e.id===id)?.title||'Event';
  if(type==='date') return id;
  return type;
}
function renderNoteText(txt){
  return txt
    .replace(/\[\[(\w+):([^\]]+)\]\]/g,(m,type,id)=>`<span class="badge" onclick="openLinked('${type}','${id}')">${getLabel(type,id)}</span>`)
    .replace(/\n/g,'<br>');
}
function openLinked(type,id){
  if(type==='project'){ $('.tab[data-tab="projects"]').click(); openProjectForm(store.projects.find(x=>x.id===id)); }
  else if(type==='shot'){ $('.tab[data-tab="shots"]').click(); openShotForm(store.shots.find(x=>x.id===id)); }
  else if(type==='task'){ $('.tab[data-tab="tasks"]').click(); editTask(id); }
  else if(type==='event'){ $('.tab[data-tab="calendar"]').click(); editEvent(id); }
  else if(type==='date'){ $('.tab[data-tab="calendar"]').click(); showAgenda(id); }
}
function openModal(title, bodyBuilder, onSave, onDelete){
  $('#modalTitle').textContent=title;
  const body=$('#modalBody'); body.innerHTML=''; bodyBuilder(body);
  $('#modal').style.display='flex';
  $('#modalSave').onclick=async()=>{
    const btn=$('#modalSave');
    btn.disabled=true;
    try{ await onSave(); }catch(err){ console.error(err); }
    btn.disabled=false;
  };
  if(onDelete){
    $('#modalDelete').style.display='';
    $('#modalDelete').onclick=()=>{ onDelete(); closeModal(); };
  } else {
    $('#modalDelete').style.display='none';
    $('#modalDelete').onclick=null;
  }
}
function closeModal(){
  $('#modal').style.display='none';
  $('#modalSave').onclick=null;
  $('#modalDelete').onclick=null;
}
$('#modal').addEventListener('click', e=>{ if(e.target.id==='modal') closeModal(); });
$('#modalClose').addEventListener('click', closeModal);

// ---------- Tabs ----------
$$('.tab').forEach(t=>t.addEventListener('click',()=>{
  $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const tab = t.dataset.tab; $$('section[id^="tab-"]').forEach(s=>s.style.display='none'); $('#tab-'+tab).style.display='';
  render();
}));

// ---------- Calendar ----------
const WEEK = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
let currentMonth = new Date();
$('#prevMonth').onclick=()=>{ currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar();};
$('#nextMonth').onclick=()=>{ currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar();};

function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

function fmtDate(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function parseDateString(str){
  const [y,m,day] = str.split('-').map(Number);
  return new Date(y, m-1, day);
}
function getDayItems(ds){
  const items=[];
  store.events.filter(e=>e.date===ds).forEach(e=>items.push({...e, kind:'event'}));
  store.shots.filter(s=>s.due===ds).forEach(s=>items.push({id:s.id, kind:'shot', type:'Shot', title:`${s.sequence||'SEQ'} / ${s.scene||'SC'} / ${s.shot||'SHOT'}`, notes:s.notes}));
  store.tasks.filter(t=>t.due===ds).forEach(t=>items.push({id:t.id, kind:'task', type:'Task', title:t.title, status:t.status, notes:t.notes, projectId:t.projectId}));
  store.notes.forEach(n=>{ if((n.tags||[]).some(tag=>tag.type==='date' && tag.id===ds)){ items.push({id:n.id, kind:'note', type:'Note', text:n.text}); }});
  return items;
}
let selectedDate = fmtDate(new Date());

function renderCalendar(){
  $('#calTitle').textContent = currentMonth.toLocaleString(undefined,{month:'long',year:'numeric'});
  const w = $('#weekdays'); w.innerHTML=''; WEEK.forEach(d=>{const el=document.createElement('div'); el.textContent=d; w.appendChild(el)});
  const grid = $('#calGrid'); grid.innerHTML='';
  const first = startOfMonth(currentMonth), last = endOfMonth(currentMonth);
  const offset = (first.getDay()+6)%7; const days = offset + last.getDate(); const rows = Math.ceil(days/7)*7;
  const today = new Date();
  for(let i=0;i<rows;i++){
    const date = addDays(first, i-offset);
    const ds = fmtDate(date);
    const cell = document.createElement('div');
    cell.className='day'+(date.getMonth()!==currentMonth.getMonth()?' other':'')+(sameDay(date,today)?' today':'');
    const num = document.createElement('div'); num.className='num'; num.textContent=date.getDate(); cell.appendChild(num);
    const chips = document.createElement('div'); chips.className='chips'; cell.appendChild(chips);
    getDayItems(ds).slice(0,3).forEach(it=>{
      const chip=document.createElement('div'); chip.className='chip '+(it.type||'').toLowerCase(); chip.textContent=it.type; chips.appendChild(chip);
      chip.addEventListener('click',()=>showAgenda(ds));
    });
    cell.addEventListener('click',()=>showAgenda(ds));
    grid.appendChild(cell);
  }
  showAgenda(selectedDate);
}

function showAgenda(ds){
  selectedDate = ds;
  const wrap = $('#agenda');
  const items = getDayItems(ds).sort((a,b)=>(a.start||'').localeCompare(b.start||''));
  if(items.length===0){ wrap.innerHTML = `<div class="small">No events on ${parseDateString(ds).toDateString()}</div>`; return;}
  wrap.innerHTML = items.map(it=>{
    if(it.kind==='event'){
      return `
    <div class="item card">
      <div>
        <h3>${it.title}</h3>
        <div class="kicker">${it.type} • ${it.start||''}${it.end?'–'+it.end:''}${it.location?' • '+it.location:''}${it.projectId?' • Project: '+(store.projects.find(p=>p.id===it.projectId)?.title||'') : ''}</div>
      </div>
      <div class="row" style="flex-direction:column;gap:8px">
        <button class="btn" onclick="editEvent('${it.id}')">Edit</button>
        <button class="btn" onclick="removeEvent('${it.id}')">Delete</button>
      </div>
    </div>`;
    } else if(it.kind==='shot'){
      return `
    <div class="item card">
      <div>
        <h3>${it.title}</h3>
        <div class="kicker">Shot</div>
        <div class="small">${it.notes||''}</div>
      </div>
      <div class="row" style="flex-direction:column;gap:8px">
        <button class="btn" onclick="openShotForm(store.shots.find(x=>x.id==='${it.id}'))">Edit</button>
      </div>
    </div>`;
    } else if(it.kind==='task'){
      const p = store.projects.find(x=>x.id===it.projectId);
      return `
    <div class="item card">
      <div>
        <h3>${it.title}</h3>
        <div class="kicker">Task${p?(' • Project: '+p.title):''} • ${it.status}</div>
        <div class="small">${it.notes||''}</div>
      </div>
      <div class="row" style="flex-direction:column;gap:8px">
        <button class="btn" onclick="editTask('${it.id}')">Edit</button>
      </div>
    </div>`;
    } else if(it.kind==='note'){
      return `
    <div class="item card">
      <div>
        <h3>Note</h3>
        <div class="small">${renderNoteText(it.text)}</div>
      </div>
      <div class="row" style="flex-direction:column;gap:8px">
        <button class="btn" onclick="openNoteForm(store.notes.find(x=>x.id==='${it.id}'))">Edit</button>
      </div>
    </div>`;
    }
    return '';
  }).join('');
}
$('#quickAddEvent').onclick=()=>openEventForm();

function openEventForm(existing){
  let data = existing || {id:uid(), title:'', type:'Shoot', date:selectedDate, start:'', end:'', location:'', projectId:''};
  openModal(existing?'Edit Event':'New Event', (body)=>{
    body.append(formRow(`<div><div class="small">Title</div><input id="evTitle" value="${data.title}"></div>`));
    body.append(formRow(`<div><div class="small">Type</div><select id="evType">
      ${['Shoot','Deadline','Review','Delivery','Shot'].map(t=>`<option ${data.type===t?'selected':''}>${t}</option>`).join('')}
    </select></div>`));
    body.append(formRow(`<div class="row"><div class="space"><div class="small">Date</div><input id="evDate" type="date" value="${data.date}"></div>
      <div class="space"><div class="small">Start</div><input id="evStart" type="time" value="${data.start}"></div>
      <div class="space"><div class="small">End</div><input id="evEnd" type="time" value="${data.end}"></div></div>`));
    body.append(formRow(`<div><div class="small">Location</div><input id="evLoc" value="${data.location}"></div>`));
    body.append(formRow(`<div><div class="small">Project</div><select id="evProj"><option value="">—</option>${store.projects.map(p=>`<option value="${p.id}" ${p.id===data.projectId?'selected':''}>${p.title}</option>`).join('')}</select></div>`));
  }, ()=>{
    data.title = $('#evTitle').value.trim()||'Untitled';
    data.type = $('#evType').value;
    data.date = $('#evDate').value;
    data.start = $('#evStart').value;
    data.end = $('#evEnd').value;
    data.location = $('#evLoc').value;
    data.projectId = $('#evProj').value;
    if(!existing) store.events.push(data);
    save(store); closeModal(); render();
  }, existing ? ()=>{ store.events = store.events.filter(x=>x.id!==existing.id); save(store); render(); } : null);
}
function editEvent(id){ const e = store.events.find(x=>x.id===id); if(e) openEventForm(e); }
function removeEvent(id){ store.events = store.events.filter(e=>e.id!==id); save(store); render(); }

// ---------- Projects ----------
$('#btnNewProject').onclick=()=>openProjectForm();
$('#projSearch').addEventListener('input', renderProjects);
function openProjectForm(existing){
  let p = existing || {id:uid(), title:'', client:'', color:'#7ca7ff', due:'', notes:''};
  openModal(existing?'Edit Project':'New Project', (body)=>{
    body.append(formRow(`<div><div class="small">Title</div><input id="pTitle" value="${p.title}"></div>`));
    body.append(formRow(`<div><div class="small">Client / Production</div><input id="pClient" value="${p.client}"></div>`));
    body.append(formRow(`<div class="row"><div class="space"><div class="small">Color</div><input id="pColor" type="color" value="${p.color}"></div>
      <div class="space"><div class="small">Due</div><input id="pDue" type="date" value="${p.due}"></div></div>`));
    body.append(formRow(`<div><div class="small">Notes</div><textarea id="pNotes">${p.notes}</textarea></div>`));
  }, ()=>{
    p.title=$('#pTitle').value.trim()||'Untitled';
    p.client=$('#pClient').value;
    p.color=$('#pColor').value||'#7ca7ff';
    p.due=$('#pDue').value;
    p.notes=$('#pNotes').value;
    if(!existing) store.projects.push(p);
    save(store); closeModal(); renderProjects();
  }, existing ? ()=>{ store.projects = store.projects.filter(x=>x.id!==existing.id); store.events = store.events.filter(e=>e.projectId!==existing.id); store.tasks = store.tasks.filter(t=>t.projectId!==existing.id); save(store); render(); } : null);
}
function renderProjects(){
  const q = ($('#projSearch').value||'').toLowerCase();
  const list = $('#projectsList'); list.innerHTML='';
  const items = store.projects.filter(p=>!q || p.title.toLowerCase().includes(q) || (p.client||'').toLowerCase().includes(q))
                              .sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  if(items.length===0){ list.innerHTML='<div class="card small">No projects yet. Tap <b>+ Project</b>.</div>'; return; }
  list.innerHTML = items.map(p=>`<div class="item card">
    <div>
      <h3>${p.title}</h3>
      <div class="kicker">${p.client||''}</div>
      <div class="kicker">Due: ${p.due?fmt(p.due):'—'}</div>
      <div class="row" style="margin-top:8px">
        <span class="badge" style="border-color:${p.color};color:${p.color}">Project</span>
        <button class="btn" onclick="openEventForm({id:'${p.id}', projectId:'${p.id}', title:'', type:'Shoot', date:'', start:'', end:'', location:''})">+ Event</button>
        <button class="btn" onclick="openTaskForm({projectId:'${p.id}'})">+ Task</button>
      </div>
    </div>
    <div class="row" style="flex-direction:column;gap:8px">
      <button class="btn" onclick="openProjectForm(store.projects.find(x=>x.id==='${p.id}'))">Edit</button>
      <button class="btn" onclick="(function(){ store.projects=store.projects.filter(x=>x.id!=='${p.id}'); store.events=store.events.filter(e=>e.projectId!=='${p.id}'); store.tasks=store.tasks.filter(t=>t.projectId!=='${p.id}'); save(store); render(); })()">Delete</button>
    </div>
  </div>`).join('');
}

// ---------- Shots ----------
$('#btnNewShot').onclick=()=>openShotForm();
$('#btnNewStoryboard').onclick=()=>openStoryboardForm();
$('#shotStatusFilter').addEventListener('change', renderShots);
function openShotForm(existing){
  let s = existing || {id:uid(), projectId:'', sequence:'', scene:'', shot:'', vendor:'', status:'Bid', due:'', notes:''};
  openModal(existing?'Edit Shot':'New Shot', (body)=>{
    body.append(formRow(`<div class="row">
      <div class="space"><div class="small">Project</div><select id="sProj"><option value="">—</option>${store.projects.map(p=>`<option value="${p.id}" ${p.id===s.projectId?'selected':''}>${p.title}</option>`).join('')}</select></div>
      <div class="space"><div class="small">Status</div><select id="sStatus">${['Bid','WIP','Review','Final'].map(x=>`<option ${s.status===x?'selected':''}>${x}</option>`).join('')}</select></div>
    </div>`));
    body.append(formRow(`<div class="row">
      <div class="space"><div class="small">Sequence</div><input id="sSeq" value="${s.sequence}"></div>
      <div class="space"><div class="small">Scene</div><input id="sScene" value="${s.scene}"></div>
      <div class="space"><div class="small">Shot</div><input id="sShot" value="${s.shot}"></div>
    </div>`));
    body.append(formRow(`<div class="row">
      <div class="space"><div class="small">Vendor</div><input id="sVendor" value="${s.vendor}"></div>
      <div class="space"><div class="small">Due</div><input id="sDue" type="date" value="${s.due}"></div>
    </div>`));
    body.append(formRow(`<div><div class="small">Notes</div><textarea id="sNotes">${s.notes}</textarea></div>`));
  }, ()=>{
    s.projectId = $('#sProj').value;
    s.status = $('#sStatus').value;
    s.sequence = $('#sSeq').value.trim();
    s.scene = $('#sScene').value.trim();
    s.shot = $('#sShot').value.trim();
    s.vendor = $('#sVendor').value.trim();
    s.due = $('#sDue').value;
    s.notes = $('#sNotes').value;
    if(!existing) store.shots.push(s);
    save(store); closeModal(); render();
  }, existing ? ()=>{ store.shots = store.shots.filter(x=>x.id!==existing.id); save(store); render(); } : null);
  }

  function openStoryboardForm(existing){
    let board = existing || {id:uid(), title:'', shots:[]};
    openModal(existing?'Edit Storyboard':'New Storyboard', (body)=>{
      body.append(formRow(`<div><div class="small">Title</div><input id="sbTitle" value="${board.title}"></div>`));
      body.append(formRow(`<div id="sbShots" style="display:flex;flex-direction:column;gap:10px"></div>`));
      body.append(formRow(`<button class="btn" type="button" id="sbAddShot">+ Add Shot</button>`));
    }, ()=>{
      board.title = $('#sbTitle').value.trim();
      const container = $('#sbShots');
      const items = Array.from(container.querySelectorAll('.sbItem'));
      board.shots = [];
      for(const item of items){
        const id = item.dataset.id || uid();
        const seq = item.querySelector('.sbSeq').value.trim();
        const scene = item.querySelector('.sbScene').value.trim();
        const shot = item.querySelector('.sbShot').value.trim();
        const camera = item.querySelector('.sbCamera').value.trim();
        const notes = item.querySelector('.sbNotes').value.trim();
        const image = item.dataset.image || '';
        board.shots.push({id, sequence:seq, scene, shot, camera, notes, image});
        let sh = store.shots.find(x=>x.id===id);
        if(!sh){ sh={id, projectId:'', sequence:seq, scene, shot, vendor:'', status:'Bid', due:'', notes}; store.shots.push(sh); }
        else { Object.assign(sh,{sequence:seq, scene, shot, notes}); }
      }
      if(!existing) store.storyboards.push(board);
      try{ save(store); }
      catch(err){ if(!existing) store.storyboards.pop(); alert('Unable to save storyboard. Storage may be full.'); return; }
      closeModal();
      render();
    }, existing ? ()=>{ store.storyboards = store.storyboards.filter(x=>x.id!==existing.id); save(store); renderStoryboards(); } : null);

    const container = $('#sbShots');
    async function resizeImage(file){
      const maxH = window.innerHeight/3;
      return new Promise(res=>{
        const reader=new FileReader();
        reader.onload=e=>{
          const img=new Image();
          img.onload=()=>{
            const h=Math.min(maxH,img.height);
            const w=img.width*h/img.height;
            const canvas=document.createElement('canvas');
            canvas.width=w; canvas.height=h;
            const ctx=canvas.getContext('2d');
            ctx.drawImage(img,0,0,w,h);
            res(canvas.toDataURL('image/jpeg',0.8));
          };
          img.src=e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
    function addShotRow(data){
      const id = data?.id || uid();
      const div = document.createElement('div');
      div.className='card sbItem';
      div.dataset.id = id;
      div.dataset.image = data?.image||'';
      div.innerHTML = `
        <div class="row">
          <div class="space"><input class="sbSeq" placeholder="Seq" value="${data?.sequence||''}"></div>
          <div class="space"><input class="sbScene" placeholder="Scene" value="${data?.scene||''}"></div>
          <div class="space"><input class="sbShot" placeholder="Shot" value="${data?.shot||''}"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="space"><input class="sbCamera" placeholder="Camera" value="${data?.camera||''}"></div>
          <div class="space"><input class="sbImage" type="file" accept="image/*"></div>
        </div>
        ${data?.image?`<img class="sbPreview" src="${data.image}" style="width:100%;margin-top:6px;height:calc(100vh/3);object-fit:cover">`:''}
        <textarea class="sbNotes" placeholder="Notes" style="margin-top:6px">${data?.notes||''}</textarea>
        <div class="row" style="margin-top:6px">
          <button class="btn sbUp" type="button">↑</button>
          <button class="btn sbDown" type="button">↓</button>
          <div class="space"></div>
          <button class="btn sbRemove" type="button">Remove</button>
        </div>`;
      container.appendChild(div);
      const fileInput = div.querySelector('.sbImage');
      fileInput.onchange=async()=>{
        if(!fileInput.files[0]) return;
        const imgData = await resizeImage(fileInput.files[0]);
        div.dataset.image = imgData;
        let prev = div.querySelector('.sbPreview');
        if(!prev){
          prev=document.createElement('img');
          prev.className='sbPreview';
          prev.style='width:100%;margin-top:6px;height:calc(100vh/3);object-fit:cover';
          const notes=div.querySelector('.sbNotes');
          div.insertBefore(prev, notes);
        }
        prev.src = imgData;
      };
      div.querySelector('.sbUp').onclick=()=>{ if(div.previousElementSibling) container.insertBefore(div, div.previousElementSibling); };
      div.querySelector('.sbDown').onclick=()=>{ if(div.nextElementSibling) container.insertBefore(div.nextElementSibling, div); };
      div.querySelector('.sbRemove').onclick=()=>div.remove();
    }
    $('#sbAddShot').onclick=()=>addShotRow();
    if(existing) existing.shots.forEach(addShotRow);
  }

  function renderStoryboards(){
    const list = $('#storyboardsList'); list.innerHTML='';
    if(!store.storyboards.length){ list.innerHTML='<div class="card small">No storyboards yet. Tap <b>+ Storyboard</b>.</div>'; return; }
    list.innerHTML = store.storyboards.map(sb=>`
      <div class="card">
        <h3>${sb.title||'Storyboard'}</h3>
        ${sb.shots.map(sh=>`
          <div style="margin-top:8px">
            ${sh.image?`<img src="${sh.image}" style="width:100%;height:calc(100vh/3);object-fit:cover">`:''}
            <div class="small">${sh.sequence||'SEQ'} / ${sh.scene||'SC'} / ${sh.shot||'SHOT'}${sh.camera?(' • Camera: '+sh.camera):''}</div>
            <div class="small">${sh.notes||''}</div>
          </div>
        `).join('')}
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="openStoryboardForm(store.storyboards.find(x=>x.id==='${sb.id}'))">Edit</button>
          <button class="btn" onclick="(function(){ store.storyboards=store.storyboards.filter(x=>x.id!=='${sb.id}'); save(store); renderStoryboards(); })()">Delete</button>
        </div>
      </div>
    `).join('');
  }

  function renderShots(){
  const f = $('#shotStatusFilter').value;
  const list = $('#shotsList'); list.innerHTML='';
  let items = store.shots.slice().sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  if(f!=='all') items = items.filter(s=> (s.status||'Bid')===f);
  if(items.length===0){ list.innerHTML='<div class="card small">No shots yet. Tap <b>+ Shot</b>.</div>'; return; }
  list.innerHTML = items.map(s=>{
    const p = store.projects.find(x=>x.id===s.projectId);
    const badge = `<span class="badge ${s.status==='Final'?'ok':(s.status==='Review'?'warn':(s.status==='WIP'?'':'danger'))}">${s.status}</span>`;
    return `<div class="item card">
      <div>
        <h3>${s.sequence || 'SEQ'} / ${s.scene || 'SC'} / ${s.shot || 'SHOT'}</h3>
        <div class="row" style="gap:6px;align-items:center;flex-wrap:wrap">
          ${badge}
          <div class="kicker">${p?('Project: '+p.title+' • '):''}Vendor: ${s.vendor||'—'} • Due: ${s.due?fmt(s.due):'—'}</div>
        </div>
        <div class="small">${s.notes||''}</div>
      </div>
      <div class="row" style="flex-direction:column;gap:8px">
        <button class="btn" onclick="openShotForm(store.shots.find(x=>x.id==='${s.id}'))">Edit</button>
        <button class="btn" onclick="(function(){ store.shots=store.shots.filter(x=>x.id!=='${s.id}'); save(store); render(); })()">Delete</button>
      </div>
    </div>`;
  }).join('');
}

// ---------- Tasks ----------
$('#btnNewTask').onclick=()=>openTaskForm();
$('#taskFilter').addEventListener('change', renderTasks);
$('#btnNewNote').onclick=()=>openNoteForm();
$('#noteFilter').addEventListener('change', renderNotes);
function openTaskForm(prefill){
  let t = {id:uid(), projectId:prefill?.projectId||'', title:'', due:'', status:'Open', notes:''};
  openModal('New Task', (body)=>{
    body.append(formRow(`<div><div class="small">Title</div><input id="tTitle" value="${t.title}"></div>`));
    body.append(formRow(`<div class="row"><div class="space"><div class="small">Project</div><select id="tProj"><option value="">—</option>${store.projects.map(p=>`<option value="${p.id}" ${p.id===t.projectId?'selected':''}>${p.title}</option>`).join('')}</select></div>
      <div class="space"><div class="small">Due</div><input id="tDue" type="date" value="${t.due}"></div></div>`));
    body.append(formRow(`<div class="row"><div class="space"><div class="small">Status</div><select id="tStatus">${['Open','In Progress','Blocked','Done'].map(x=>`<option>${x}</option>`).join('')}</select></div></div>`));
    body.append(formRow(`<div><div class="small">Notes</div><textarea id="tNotes">${t.notes}</textarea></div>`));
  }, ()=>{
    t.title = $('#tTitle').value.trim()||'Untitled Task';
    t.projectId = $('#tProj').value;
    t.due = $('#tDue').value;
    t.status = $('#tStatus').value;
    t.notes = $('#tNotes').value;
  store.tasks.push(t); save(store); closeModal(); render();
  });
}

function editTask(id){
  const tt = store.tasks.find(x=>x.id===id); if(!tt) return;
  openModal('Edit Task', (body)=>{
    body.append(formRow(`<div><div class="small">Title</div><input id="tTitle" value="${tt.title}"></div>`));
    body.append(formRow(`<div class="row"><div class="space"><div class="small">Project</div><select id="tProj"><option value="">—</option>${store.projects.map(p=>`<option value="${p.id}" ${p.id===tt.projectId?'selected':''}>${p.title}</option>`).join('')}</select></div>
      <div class="space"><div class="small">Due</div><input id="tDue" type="date" value="${tt.due||''}"></div></div>`));
    body.append(formRow(`<div class="row"><div class="space"><div class="small">Status</div><select id="tStatus">${['Open','In Progress','Blocked','Done'].map(x=>`<option ${tt.status===x?'selected':''}>${x}</option>`).join('')}</select></div></div>`));
    body.append(formRow(`<div><div class="small">Notes</div><textarea id="tNotes">${tt.notes||''}</textarea></div>`));
  }, ()=>{
    tt.title=$('#tTitle').value; tt.projectId=$('#tProj').value; tt.due=$('#tDue').value; tt.status=$('#tStatus').value; tt.notes=$('#tNotes').value;
    save(store); closeModal(); render();
  }, ()=>{ store.tasks=store.tasks.filter(x=>x.id!==id); save(store); render(); });
}
function renderTasks(){
  const f = $('#taskFilter').value;
  const list = $('#tasksList'); list.innerHTML='';
  let items = store.tasks.slice().sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  if(f!=='all') items = items.filter(t=> (t.status||'Open')===f);
  if(items.length===0){ list.innerHTML='<div class="card small">No tasks yet. Tap <b>+ Task</b>.</div>'; return; }
  list.innerHTML = items.map(t=>{
    const p = store.projects.find(x=>x.id===t.projectId);
    return `<div class="item card">
      <div>
        <h3>${t.title}</h3>
        <div class="kicker">${p?('Project: '+p.title+' • '):''}Due: ${t.due?fmt(t.due):'—'} • ${t.status}</div>
        <div class="small">${t.notes||''}</div>
      </div>
      <div class="row" style="flex-direction:column;gap:8px">
        <button class="btn" onclick="editTask('${t.id}')">Edit</button>
        <button class="btn" onclick="(store.tasks=store.tasks.filter(x=>x.id!=='${t.id}'), save(store), render())">Delete</button>
      </div>
    </div>`;
  }).join('');
}

// ---------- Notes ----------
function openNoteForm(existing){
  let n = existing || {id:uid(), text:'', tags:[]};
  openModal(existing?'Edit Note':'New Note', (body)=>{
    body.append(formRow(`<div><div class="small">Text</div><textarea id="nText">${n.text}</textarea></div>`));
    body.append(formRow(`<div id="nTags" style="display:flex;flex-direction:column;gap:6px"></div>`));
    body.append(formRow(`<button class="btn" type="button" id="nAddTag">+ Tag</button>`));
    body.append(formRow(`<button class="btn" type="button" id="nInsertLink">Insert Link</button>`));
    }, ()=>{
      n.text = $('#nText').value;
      const tags=[];
      $('#nTags').querySelectorAll('.tagRow').forEach(row=>{
        const type=row.querySelector('.tagType').value;
        const val=row.querySelector('.tagValue')?.value;
        if(type && val) tags.push({type,id:val});
      });
      n.tags = tags;
      if(!existing) store.notes.push(n);
      save(store);
      closeModal();
      render();
    }, existing ? ()=>{
      store.notes = store.notes.filter(x=>x.id!==existing.id);
      save(store);
      render();
    } : null);

  function addTagRow(tag){
    const div=document.createElement('div');
    div.className='row tagRow';
    div.innerHTML=`<div class="space"><select class="tagType">
      <option value="">Type</option>
      <option value="project">Project</option>
      <option value="shot">Shot</option>
      <option value="task">Task</option>
      <option value="event">Event</option>
      <option value="date">Date</option>
      </select></div><div class="space tagWrap"></div><button class="btn" type="button" onclick="this.parentElement.remove()">Remove</button>`;
    $('#nTags').appendChild(div);
    const typeSel=div.querySelector('.tagType');
    const wrap=div.querySelector('.tagWrap');
    function populate(){
      const t=typeSel.value; wrap.innerHTML='';
      if(t==='project') wrap.innerHTML=`<select class="tagValue"><option value="">—</option>${store.projects.map(p=>`<option value="${p.id}">${p.title}</option>`).join('')}</select>`;
      else if(t==='shot') wrap.innerHTML=`<select class="tagValue"><option value="">—</option>${store.shots.map(s=>`<option value="${s.id}">${s.sequence||'SEQ'}/${s.scene||'SC'}/${s.shot||'SHOT'}</option>`).join('')}</select>`;
      else if(t==='task') wrap.innerHTML=`<select class="tagValue"><option value="">—</option>${store.tasks.map(t=>`<option value="${t.id}">${t.title}</option>`).join('')}</select>`;
      else if(t==='event') wrap.innerHTML=`<select class="tagValue"><option value="">—</option>${store.events.map(e=>`<option value="${e.id}">${e.title} (${e.date})</option>`).join('')}</select>`;
      else if(t==='date') wrap.innerHTML=`<input type="date" class="tagValue">`;
      if(tag && tag.type===t){ wrap.querySelector('.tagValue').value=tag.id; }
    }
    typeSel.onchange=populate;
    if(tag){ typeSel.value=tag.type; }
    populate();
  }
  $('#nAddTag').onclick=()=>addTagRow();
  if(n.tags) n.tags.forEach(addTagRow);

  $('#nInsertLink').onclick=()=>{
    const type = prompt('Link type (project/shot/task/event/date)');
    if(!type) return;
    let id='';
    if(type==='date'){
      id = prompt('Date (YYYY-MM-DD)')||'';
    } else {
      const arr = store[type+'s']||[];
      if(!arr.length){ alert('No items'); return; }
      const list = arr.map((it,i)=>`${i+1}. ${getLabel(type,it.id)}`).join('\n');
      const pick = parseInt(prompt('Choose '+type+':\n'+list))-1;
      if(isNaN(pick)||!arr[pick]) return;
      id = arr[pick].id;
    }
      if(id){ const ta=$('#nText'); ta.value += ` [[${type}:${id}]]`; }
    };
  }

function renderNotes(){
  const filterSel = $('#noteFilter');
  const val = filterSel.value;
  let opts = '<option value="all">All</option>';
  if(store.projects.length) opts += '<optgroup label="Projects">'+store.projects.map(p=>`<option value="project:${p.id}">${p.title}</option>`).join('')+'</optgroup>';
  if(store.shots.length) opts += '<optgroup label="Shots">'+store.shots.map(s=>`<option value="shot:${s.id}">${s.sequence||'SEQ'}/${s.scene||'SC'}/${s.shot||'SHOT'}</option>`).join('')+'</optgroup>';
  if(store.tasks.length) opts += '<optgroup label="Tasks">'+store.tasks.map(t=>`<option value="task:${t.id}">${t.title}</option>`).join('')+'</optgroup>';
  if(store.events.length) opts += '<optgroup label="Events">'+store.events.map(e=>`<option value="event:${e.id}">${e.title} (${e.date})</option>`).join('')+'</optgroup>';
  filterSel.innerHTML = opts;
  filterSel.value = val==='all'||filterSel.querySelector(`option[value='${val}']`)?val:'all';
  const f = filterSel.value;
  const list = $('#notesList');
  let items = store.notes.slice();
  if(f!=='all'){ const [ft,fi] = f.split(':'); items = items.filter(n=>n.tags.some(t=>t.type===ft && t.id===fi)); }
  if(items.length===0){ list.innerHTML='<div class="card small">No notes yet. Tap <b>+ Note</b>.</div>'; return; }
  list.innerHTML = items.map(n=>`<div class="item card">
      <div>${renderNoteText(n.text)}<div class="small">${n.tags.map(t=>getLabel(t.type,t.id)).join(', ')}</div></div>
      <div class="row" style="flex-direction:column;gap:8px">
        <button class="btn" onclick="openNoteForm(store.notes.find(x=>x.id==='${n.id}'))">Edit</button>
        <button class="btn" onclick="(store.notes=store.notes.filter(x=>x.id!=='${n.id}'), save(store), render())">Delete</button>
      </div>
    </div>`).join('');
}

// ---------- Import / Export ----------
$('#btnExport').onclick=()=>{
  const data = JSON.stringify(store, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='cinematix-backup.json'; a.click();
  URL.revokeObjectURL(url);
};
$('#btnImport').onclick=()=>$('#fileImport').click();
$('#fileImport').addEventListener('change', (ev)=>{
  const file = ev.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{ try{ store = JSON.parse(reader.result); save(store); render(); } catch{ alert('Invalid file'); } };
  reader.readAsText(file); ev.target.value='';
});

// ---------- Render all ----------
function render(){ renderCalendar(); renderProjects(); renderStoryboards(); renderShots(); renderTasks(); renderNotes(); }
function boot(){
  render();
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(console.error));
  }
}
boot();
</script>
</body>
</html>
